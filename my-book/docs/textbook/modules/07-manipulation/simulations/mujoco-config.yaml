# MuJoCo Simulation Configuration for Module 07: Manipulation
# This configuration defines the simulation environment for manipulation labs

id: mod07-manipulation
platform: mujoco
version: "3.0+"

# Primary robot model
robot_model:
  path: textbook/assets/robot-models/mujoco/gripper-table.xml
  description: Parallel jaw gripper with tabletop environment

# Alternate models
alternate_models:
  - id: arm-contact
    path: textbook/assets/robot-models/mujoco/arm-contact-table.xml
    description: 7-DOF arm with force/torque sensing at end-effector
    labs: [lab-07-02]
  - id: shadow-hand
    path: textbook/assets/robot-models/mujoco/shadow-hand.xml
    description: Shadow Dexterous Hand (20+ DOF)
    labs: [lab-07-03, project]
  - id: two-finger
    path: textbook/assets/robot-models/mujoco/two-finger-gripper.xml
    description: Simplified two-finger adaptive gripper
    labs: [lab-07-01]

# Environment configuration
environment:
  scene: manipulation_workspace
  ground_plane: true
  gravity: [0, 0, -9.81]

  # Table surface
  table:
    position: [0.5, 0, 0.4]
    size: [0.4, 0.6, 0.02]
    material: wood
    friction: [0.8, 0.01, 0.001]

  # Grasping objects
  objects:
    - id: box_small
      type: box
      size: [0.03, 0.02, 0.015]
      mass: 0.1
      friction: [0.6, 0.005, 0.0001]
      color: [0.8, 0.2, 0.2, 1.0]
      position: [0.5, 0.0, 0.43]

    - id: cylinder_medium
      type: cylinder
      size: [0.025, 0.04]  # radius, half-height
      mass: 0.15
      friction: [0.6, 0.005, 0.0001]
      color: [0.2, 0.8, 0.2, 1.0]
      position: [0.5, 0.1, 0.44]

    - id: sphere_small
      type: sphere
      size: [0.03]  # radius
      mass: 0.12
      friction: [0.7, 0.005, 0.0001]
      color: [0.2, 0.2, 0.8, 1.0]
      position: [0.5, -0.1, 0.43]

    - id: plate_thin
      type: box
      size: [0.05, 0.04, 0.003]
      mass: 0.05
      friction: [0.5, 0.005, 0.0001]
      color: [0.8, 0.8, 0.2, 1.0]
      position: [0.4, 0.05, 0.415]

    - id: irregular_mesh
      type: mesh
      file: textbook/assets/objects/irregular-shape.obj
      scale: 0.01
      mass: 0.2
      friction: [0.6, 0.005, 0.0001]
      position: [0.6, 0.0, 0.45]

# Physics settings
physics:
  timestep: 0.002  # 500 Hz for contact stability
  gravity: [0, 0, -9.81]
  solver_iterations: 100  # Higher for stable contacts
  integrator: implicitfast
  cone: pyramidal  # Friction cone approximation
  noslip_iterations: 10  # Better contact behavior

# Contact parameters
contact:
  condim: 4  # 4D contact (3 friction + 1 normal)
  friction: [0.6, 0.6, 0.001]  # sliding, torsion, rolling
  solref: [0.02, 1]  # Stiffness and damping
  solimp: [0.9, 0.95, 0.001]  # Constraint impedance
  margin: 0.001  # Contact detection margin
  gap: 0.0  # Contact gap

# Gripper parameters
gripper:
  parallel_jaw:
    max_width: 0.1  # meters
    min_width: 0.0
    max_force: 50  # Newtons
    speed: 0.1  # m/s
    stiffness: 1000  # N/m when gripping

  shadow_hand:
    num_fingers: 5
    dof_per_finger: [5, 4, 4, 4, 4]  # thumb has 5 DOF
    joint_limits: [-0.5, 1.57]  # radians
    torque_limits: [-1.0, 1.0]  # Nm

# Force sensing configuration
sensors:
  force_torque:
    - name: ee_force
      site: end_effector
      type: force
      noise: 0.1  # N standard deviation
    - name: ee_torque
      site: end_effector
      type: torque
      noise: 0.01  # Nm standard deviation

  tactile:
    - name: left_finger_tactile
      type: contact_array
      resolution: [4, 4]  # 16 taxels
      site: left_finger_pad
    - name: right_finger_tactile
      type: contact_array
      resolution: [4, 4]
      site: right_finger_pad

# Visualization settings
visualization:
  render_mode: window
  camera:
    position: [1.0, -0.5, 1.0]
    lookat: [0.5, 0, 0.4]
  show_contacts: true
  show_forces: true
  contact_force_scale: 0.01

# Lab-specific configurations
lab_configs:
  lab-07-01:
    description: "Basic Grasping"
    robot: parallel_jaw
    objects: [box_small, cylinder_medium]
    tasks:
      - name: top_grasp
        object: box_small
        approach: top_down
        success_metric: lift_height > 0.1
      - name: side_grasp
        object: cylinder_medium
        approach: horizontal
        success_metric: lift_height > 0.1

  lab-07-02:
    description: "Force Control and Compliance"
    robot: arm-contact
    impedance_params:
      stiffness_range: [100, 2000]  # N/m
      damping_range: [10, 100]  # Ns/m
    force_control:
      target_forces: [5, 10, 20]  # N
      settling_threshold: 0.1  # N
    tasks:
      - name: surface_contact
        target_force: 10
        duration: 5
        success_metric: force_error < 1.0
      - name: surface_following
        path: circular
        target_force: 5
        success_metric: force_std < 0.5

  lab-07-03:
    description: "Dexterous Manipulation"
    robot: shadow-hand
    grasp_analysis:
      friction_coefficient: 0.5
      force_closure_required: true
      min_contacts: 3
    in_hand_tasks:
      - name: rotation_z
        axis: [0, 0, 1]
        angle: 1.57  # 90 degrees
        success_metric: angle_error < 0.1
      - name: translation
        direction: [0, 0, 1]
        distance: 0.02
        success_metric: position_error < 0.005

# Grasp quality metrics
grasp_metrics:
  epsilon_metric: true  # Largest inscribed ball in GWS
  volume_metric: true  # Volume of GWS
  min_singular_value: true  # Grasp matrix quality
  contact_count: true
  force_closure: true

# Project configuration
project:
  object_set:
    - box_small
    - cylinder_medium
    - sphere_small
    - plate_thin
    - irregular_mesh

  placement_targets:
    - name: bin_left
      position: [0.3, 0.3, 0.4]
      tolerance: 0.02
    - name: bin_right
      position: [0.3, -0.3, 0.4]
      tolerance: 0.02
    - name: stack_area
      position: [0.7, 0, 0.4]
      tolerance: 0.01

  evaluation:
    attempts_per_object: 3
    positions: [center, edge, cluttered]
    success_criteria:
      position_tolerance: 0.02
      orientation_tolerance: 0.2  # rad
      grasp_time_limit: 30  # seconds

# Testing configuration
testing:
  unit_tests:
    - name: grasp_pose_generation
      object: box_small
      expected_grasps: "> 4"
    - name: force_control_step_response
      input_force: 10
      settling_time: "< 1.0"
    - name: impedance_compliance
      perturbation: 5
      deflection: "> 0.005"

  integration_tests:
    - name: full_pick_place
      objects: [box_small, cylinder_medium]
      success_rate: "> 0.9"

# Docker/container setup
docker:
  image: mujoco-manipulation:mod07
  build_context: docker/ros2-humble/
  volumes:
    - ./textbook:/textbook:ro
    - ./data:/data:rw
  gpu: true  # For rendering

# References
references:
  - textbook/modules/07-manipulation/theory.md
  - textbook/modules/07-manipulation/labs/
  - textbook/case-studies/manufacturing/2024-amazon-digit.md
