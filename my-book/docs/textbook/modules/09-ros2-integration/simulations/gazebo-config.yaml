# Gazebo Simulation Configuration for Module 09: ROS2 Integration
# This configuration defines the Gazebo simulation environment

id: mod09-ros2-integration
platform: gazebo
version: "Fortress (6.x) / Garden (7.x)"

# Gazebo world configuration
world:
  name: ros2_integration_world
  physics:
    engine: ode
    max_step_size: 0.001  # 1ms
    real_time_factor: 1.0
    real_time_update_rate: 1000
    gravity: [0, 0, -9.81]

  # World plugins
  plugins:
    - name: gz::sim::systems::Physics
    - name: gz::sim::systems::Sensors
      render_engine: ogre2
    - name: gz::sim::systems::SceneBroadcaster
    - name: gz::sim::systems::UserCommands
    - name: gz::sim::systems::Contact

  # Environment
  lighting:
    ambient: [0.4, 0.4, 0.4, 1.0]
    sun:
      direction: [-0.5, 0.1, -0.9]
      diffuse: [0.8, 0.8, 0.8, 1.0]
      specular: [0.2, 0.2, 0.2, 1.0]
      cast_shadows: true

  ground:
    size: [20, 20]
    friction: [0.8, 0.8, 0.0]
    material:
      ambient: [0.3, 0.3, 0.3, 1.0]

# Robot model configuration
robot_model:
  name: simple_arm
  path: textbook/assets/robot-models/gazebo/simple_arm.sdf
  spawn_pose: [0, 0, 0.1, 0, 0, 0]

  # Links
  links:
    - name: base_link
      mass: 5.0
      collision: cylinder
      visual: cylinder

    - name: link1
      mass: 2.0
      parent: base_link
      joint: revolute_z

    - name: link2
      mass: 1.5
      parent: link1
      joint: revolute_y

    - name: end_effector
      mass: 0.5
      parent: link2
      joint: fixed

  # Joints
  joints:
    - name: joint1
      type: revolute
      axis: [0, 0, 1]
      limits:
        lower: -3.14
        upper: 3.14
        effort: 50
        velocity: 2
      dynamics:
        damping: 0.5
        friction: 0.1

    - name: joint2
      type: revolute
      axis: [0, 1, 0]
      limits:
        lower: -2.0
        upper: 2.0
        effort: 30
        velocity: 2
      dynamics:
        damping: 0.3
        friction: 0.1

  # Robot plugins
  plugins:
    - name: gz::sim::systems::JointStatePublisher
      joints: [joint1, joint2]
      topic: /joint_states
      update_rate: 100

    - name: gz::sim::systems::JointPositionController
      joint: joint1
      topic: /joint1_cmd
      p_gain: 100
      d_gain: 10

    - name: gz::sim::systems::JointPositionController
      joint: joint2
      topic: /joint2_cmd
      p_gain: 80
      d_gain: 8

# Sensor configuration
sensors:
  camera:
    name: robot_camera
    parent: end_effector
    pose: [0.05, 0, 0.02, 0, 0.707, 0, 0.707]
    type: camera
    horizontal_fov: 1.047  # 60 degrees
    image:
      width: 640
      height: 480
      format: R8G8B8
    clip:
      near: 0.1
      far: 10.0
    update_rate: 30
    topic: /camera

  imu:
    name: robot_imu
    parent: base_link
    pose: [0, 0, 0.1, 0, 0, 0]
    type: imu
    update_rate: 100
    noise:
      rate:
        mean: 0
        stddev: 0.01
      accel:
        mean: 0
        stddev: 0.1
    topic: /imu

  lidar:
    name: robot_lidar
    parent: base_link
    pose: [0.1, 0, 0.3, 0, 0, 0]
    type: gpu_lidar
    horizontal:
      samples: 720
      min_angle: -3.14
      max_angle: 3.14
    vertical:
      samples: 1
    range:
      min: 0.1
      max: 10.0
    update_rate: 10
    noise:
      type: gaussian
      mean: 0
      stddev: 0.01
    topic: /scan

# ROS-Gazebo bridge configuration
bridge:
  # Bidirectional topics
  topics:
    # Gazebo to ROS
    - gz_topic: /joint_states
      ros_topic: /joint_states
      gz_type: gz.msgs.Model
      ros_type: sensor_msgs/msg/JointState
      direction: GZ_TO_ROS

    - gz_topic: /camera
      ros_topic: /camera/image_raw
      gz_type: gz.msgs.Image
      ros_type: sensor_msgs/msg/Image
      direction: GZ_TO_ROS

    - gz_topic: /camera_info
      ros_topic: /camera/camera_info
      gz_type: gz.msgs.CameraInfo
      ros_type: sensor_msgs/msg/CameraInfo
      direction: GZ_TO_ROS

    - gz_topic: /imu
      ros_topic: /imu
      gz_type: gz.msgs.IMU
      ros_type: sensor_msgs/msg/Imu
      direction: GZ_TO_ROS

    - gz_topic: /scan
      ros_topic: /scan
      gz_type: gz.msgs.LaserScan
      ros_type: sensor_msgs/msg/LaserScan
      direction: GZ_TO_ROS

    # ROS to Gazebo
    - gz_topic: /model/simple_arm/joint/joint1/cmd_pos
      ros_topic: /joint1_cmd
      gz_type: gz.msgs.Double
      ros_type: std_msgs/msg/Float64
      direction: ROS_TO_GZ

    - gz_topic: /model/simple_arm/joint/joint2/cmd_pos
      ros_topic: /joint2_cmd
      gz_type: gz.msgs.Double
      ros_type: std_msgs/msg/Float64
      direction: ROS_TO_GZ

  # Services
  services:
    - gz_service: /world/ros2_integration_world/create
      ros_service: /spawn_entity
      direction: ROS_TO_GZ

# Lab-specific configurations
lab_configs:
  lab-09-01:
    description: "ROS2 Fundamentals"
    nodes:
      - joint_publisher
      - joint_subscriber
      - robot_service
    topics:
      - /joint_commands
      - /joint_states
    services:
      - /robot/enable

  lab-09-02:
    description: "tf2 and Coordinate Frames"
    frames:
      static:
        - parent: base_link
          child: imu_link
        - parent: base_link
          child: lidar_link
        - parent: end_effector
          child: camera_link
      dynamic:
        - parent: base_link
          child: link1
        - parent: link1
          child: link2
        - parent: link2
          child: end_effector

  lab-09-03:
    description: "Gazebo Integration"
    gazebo_features:
      - physics_simulation
      - sensor_plugins
      - ros_bridge
      - visualization
    test_scenarios:
      - name: trajectory_tracking
        duration: 10
        success_metric: tracking_error < 0.05
      - name: sensor_processing
        duration: 5
        success_metric: detection_rate > 0.9

# Test objects
test_objects:
  - name: target_box
    type: box
    size: [0.1, 0.1, 0.1]
    mass: 0.5
    pose: [1, 0, 0.05, 0, 0, 0]
    material:
      ambient: [0.8, 0.2, 0.2, 1]
      friction: 0.6

  - name: target_cylinder
    type: cylinder
    radius: 0.05
    length: 0.15
    mass: 0.3
    pose: [1.2, 0.3, 0.075, 0, 0, 0]
    material:
      ambient: [0.2, 0.8, 0.2, 1]
      friction: 0.6

  - name: target_sphere
    type: sphere
    radius: 0.06
    mass: 0.4
    pose: [0.8, -0.3, 0.06, 0, 0, 0]
    material:
      ambient: [0.2, 0.2, 0.8, 1]
      friction: 0.7

# Performance metrics
metrics:
  communication:
    - topic_latency_ms
    - message_rate_hz
    - dropped_messages

  simulation:
    - real_time_factor
    - physics_step_time_ms
    - render_fps

  control:
    - tracking_error_rad
    - command_response_time_ms
    - steady_state_error

# Visualization
visualization:
  rviz_config: ros2_integration.rviz
  displays:
    - TF (all frames)
    - RobotModel
    - Camera image
    - LaserScan
    - MarkerArray (detections)

# Docker configuration
docker:
  base_image: ros:humble-ros-base
  additional_packages:
    - ros-humble-gazebo-ros-pkgs
    - ros-humble-ros-gz-bridge
    - ros-humble-ros-gz-sim
    - ros-humble-rviz2
    - ros-humble-tf2-tools
  build_context: docker/ros2-humble/
  volumes:
    - ./textbook:/textbook:ro
    - /tmp/.X11-unix:/tmp/.X11-unix

# Testing
testing:
  unit_tests:
    - name: publisher_rate
      expected: 100 Hz Â± 5%
    - name: bridge_latency
      expected: < 10 ms
    - name: tf_lookup
      expected: < 1 ms

  integration_tests:
    - name: full_system_launch
      timeout: 30
      success_criteria: all_nodes_running
    - name: control_loop
      duration: 10
      success_criteria: no_errors

# References
references:
  - textbook/modules/09-ros2-integration/theory.md
  - textbook/modules/09-ros2-integration/labs/
  - https://docs.ros.org/en/humble/
  - https://gazebosim.org/docs/fortress/
